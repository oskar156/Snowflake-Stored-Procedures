/*
DEDUPE_OK (TABLE_NAME string, COLS string)
RETURNS STRING (output message for user)
dedupes and replaces TABLE_NAME
*/
                
CREATE OR REPLACE PROCEDURE DEDUPE_OK (
    TABLE_NAME string
    ,COLS string
)
RETURNS STRING
LANGUAGE SQL 
AS
$$
DECLARE
    QUERY STRING;
    OUTPUT_MSG STRING;
BEGIN
    QUERY := 'SELECT COUNT(*) FROM IDENTIFIER(''"'||:TABLE_NAME||'"'');';
    LET COUNT_OG_RES RESULTSET := (EXECUTE IMMEDIATE :QUERY);
    LET COUNT_OG INT := 0;
    LET CUR1 CURSOR FOR COUNT_OG_RES;
    OPEN CUR1;
    FETCH CUR1 INTO COUNT_OG;
    CLOSE CUR1;

    QUERY := ' 
        CREATE OR REPLACE TABLE IDENTIFIER(''"'||:TABLE_NAME||'"'') AS
        SELECT *
        FROM IDENTIFIER(''"'||:TABLE_NAME||'"'')
        QUALIFY (ROW_NUMBER() OVER (PARTITION BY '||COLS||' ORDER BY '||COLS||')) = 1;
    ';
    EXECUTE IMMEDIATE :QUERY;

    QUERY := 'SELECT COUNT(*) FROM IDENTIFIER(''"'||:TABLE_NAME||'"'');';
    LET COUNT_NEW_RES RESULTSET := (EXECUTE IMMEDIATE :QUERY);
    LET COUNT_NEW INT := 0;
    LET CUR2 CURSOR FOR COUNT_NEW_RES;
    OPEN CUR2;
    FETCH CUR2 INTO COUNT_NEW;
    CLOSE CUR2;

    OUTPUT_MSG := '"'||TABLE_NAME||'" deduped by '||COLS||'. Quantity went from '||COUNT_OG||' to '||COUNT_NEW||'.';

    --output message for user
    RETURN OUTPUT_MSG;
END;
$$;
                
